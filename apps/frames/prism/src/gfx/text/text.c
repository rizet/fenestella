#include "gfx/text/text.h"
#include "lib/glass.h"
#include <stddef.h>
#include <string.h>

#define TEXT_BACKGROUND_COLOR    0x00111111  // faint dark gray

#define TEXT_GLYPH_WIDTH         0x08
#define TEXT_GLYPH_HEIGHT        0x08

extern uint64_t __integrated_font[];

static uint8_t __font_booleans[0x100][0x40];

static void _text_renderer_load_glyph() {
	for (uint64_t i = 0; i < 0x100; i++) {
		for (uint64_t j = 0; j < 0x40; j++) {
			__font_booleans[i][j] = (__integrated_font[i] >> j) & 1;
		}
	}
}

static uint32_t* screen_fb;
static uint64_t screen_width, screen_height;
static uint64_t screen_cols, screen_rows;
static uint64_t glyph_width, glyph_height;
static bool glyphs_loaded;
static bool screen_ready = false;

static inline bool text_glyph_read(unsigned char c, uint64_t at) {
	return (bool)__font_booleans[c][at];
}

void text_render_load_dimensions(uint64_t screen_wide, uint64_t screen_high) {
	glyphs_loaded = true;
	if (!glyphs_loaded) {	// placeholder
		return;
	}
	glyph_width = TEXT_GLYPH_WIDTH;
	glyph_height = TEXT_GLYPH_HEIGHT;
	screen_width = screen_wide;
	screen_height = screen_high;
	screen_cols = screen_width / glyph_width;
	screen_rows = screen_height / glyph_height;
}

void text_render_init() {
	if (screen_ready)
		return;
	screen_fb = fb_req();
	if (!screen_fb) return;
	text_render_load_dimensions(rdinfo(FIELD_DISPLAY_WIDTH), rdinfo(FIELD_DISPLAY_HEIGHT));
	_text_renderer_load_glyph();
	screen_ready = true;
	text_render_clear();
}

void text_render_stop() {
	if (!screen_ready)
		return;
	screen_ready = false;
	fb_kill();
}

void text_render_clear() {
	if (!screen_ready)
		return;
	memset((void *)screen_fb, 0x00, (screen_width * screen_height * sizeof(uint32_t)));
}

uint64_t text_render_get_width() {
	return screen_width;
}
uint64_t text_render_get_height() {
	return screen_height;
}
uint64_t text_render_get_cols() {
	return screen_cols;
}
uint64_t text_render_get_rows() {
	return screen_rows;
}

uint32_t text_translate_color_code(uint8_t color_code) {
	switch (color_code) 
	{
		case TEXT_COLOR_BLACK:
			return TEXT_BACKGROUND_COLOR;
		case TEXT_COLOR_WHITE:
			return 0xFFFFFF;
		case TEXT_COLOR_RED:
			return 0xFF0000;
		case TEXT_COLOR_BLUE:
			return 0x2222FF;
		case TEXT_COLOR_GREEN:
			return 0x22FF22;
		case TEXT_COLOR_CYAN:
			return 0x11FFFF;
		case TEXT_COLOR_MAGENTA:
			return 0xFF01AA;
		case TEXT_COLOR_BROWN:
			return 0xFFEBCD;
		case TEXT_COLOR_LIGHT_GREY:
			return 0xDDDDDD;
		case TEXT_COLOR_DARK_GREY:
			return 0x555555;
		case TEXT_COLOR_LIGHT_BLUE:
			return 0x01AAFF;
		case TEXT_COLOR_LIGHT_GREEN:
			return 0x01FF01;
		case TEXT_COLOR_LIGHT_CYAN:
			return 0x01DDFF;
		case TEXT_COLOR_LIGHT_RED:
			return 0xFF2222;
		case TEXT_COLOR_LIGHT_MAGENTA:
			return 0xFF0077;
		case TEXT_COLOR_LIGHT_BROWN:
			return 0x8B4513;
	}

	return TEXT_BACKGROUND_COLOR;
}

void text_render_place_at(text_render_pos_t pos, char c, uint8_t color) {
	if (!screen_ready)
		return;
	uint32_t fore_pixel = text_translate_color_code(TEXT_COLOR_GET_FG(color));
	uint32_t back_pixel = text_translate_color_code(TEXT_COLOR_GET_BG(color));
	uint64_t p_x = (pos.p_x * TEXT_GLYPH_WIDTH);
	uint64_t p_y = (pos.p_y * TEXT_GLYPH_HEIGHT);
	uint64_t _x = 0;
	for (uint64_t xx = p_x; xx < p_x+TEXT_GLYPH_WIDTH; xx++) {
		uint64_t _y = 0;
		for (uint64_t yy = p_y; yy < p_y+TEXT_GLYPH_HEIGHT; yy++) {
			screen_fb[(yy * screen_width) + xx] = text_glyph_read(c, (_y * glyph_width + _x)) ? fore_pixel : back_pixel;
			_y++;
		}
		_x++;
	}
}

void text_render_clean_at(text_render_pos_t pos) {
	if (!screen_ready)
		return;
	uint64_t p_x = (pos.p_x * TEXT_GLYPH_WIDTH);
	uint64_t p_y = (pos.p_y * TEXT_GLYPH_HEIGHT);
	for (uint64_t xx = p_x; xx < p_x+TEXT_GLYPH_WIDTH; xx++) {
		for (uint64_t yy = p_y; yy < p_y+TEXT_GLYPH_HEIGHT; yy++) {
			screen_fb[(yy * screen_width) + xx] = 0x00;
		}
	}
}

// index is ascii/utf8 bytecode
uint64_t __integrated_font[] =
{
	0x0000000000000000,
	0x0000000000000000,
	0x000000FF00000000,
	0x000000FF00FF0000,
	0x1818181818181818,
	0x6C6C6C6C6C6C6C6C,
	0x181818F800000000,
	0x6C6C6CEC0CFC0000,
	0x1818181F00000000,
	0x6C6C6C6F607F0000,
	0x000000F818181818,
	0x000000FC0CEC6C6C,
	0x0000001F18181818,
	0x0000007F606F6C6C,
	0x187E7EFFFF7E7E18,  // circle  0x00187EFFFF7E1800
	0x0081818181818100,  // square
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0000000000000000,
	0x0008000000000000,//
	0x0000000000000000,//
	0x00180018183C3C18,//!
	0x0000000000121236,//"
	0x006C6CFE6CFE6C6C,//#
	0x00187ED07C16FC30,//$$
	0x0060660C18306606,//%
	0x00DC66B61C36361C,//&
	0x0000000000181818,//'
	0x0030180C0C0C1830,//(
	0x000C18303030180C,//)
	0x0000187E3C7E1800,//*
	0x000018187E181800,//+
	0x0C18180000000000,//,
	0x000000007E000000,//-
	0x0018180000000000,//.
	0x0000060C18306000,///
	0x003C42464A52623C,//0
	0x007E101010101C10,//1
	0x007E04081020423C,//2
	0x003C42403840423C,//3
	0x0020207E22242830,//4
	0x003C4240403E027E,//5
	0x003C42423E020438,//6
	0x000404081020407E,//7
	0x003C42423C42423C,//8
	0x001C20407C42423C,//9
	0x0018180018180000,//:
	0x0C18180018180000,//;
	0x0030180C060C1830,//<
	0x0000007E007E0000,//=
	0x000C18306030180C,//>
	0x001800181830663C,//?
	0x003C06765676663C,//@
	0x0042427E42422418,//A
	0x003E42423E42423E,//B
	0x003C42020202423C,//C
	0x001E22424242221E,//D
	0x007E02023E02027E,//E
	0x000202023E02027E,//F
	0x003C42427202423C,//G
	0x004242427E424242,//H
	0x007C10101010107C,//I
	0x001C22202020207E,//J
	0x004222120E0A1222,//K
	0x007E020202020202,//L
	0x0082828292AAC682,//M
	0x00424262524A4642,//N
	0x003C42424242423C,//O
	0x000202023E42423E,//P
	0x005C22424242423C,//Q
	0x004242423E42423E,//R
	0x003C42403C02423C,//S
	0x001010101010107C,//T
	0x003C424242424242,//U
	0x0018244242424242,//V
	0x0044AAAA92828282,//W
	0x0042422418244242,//X
	0x0010101038444444,//Y
	0x007E04081020407E,//Z
	0x003E02020202023E,//[
	0x00006030180C0600,  /* //\ */
	0x007C40404040407C,  //]
	0x000000000000663C,//^
	0xFF00000000000000,//_
	0x000000000030180C,//`
	0x007C427C403C0000,//a
	0x003E4242423E0202,//b
	0x003C4202423C0000,//c
	0x007C4242427C4040,//d
	0x003C027E423C0000,//e
	0x000404043E040438,//f
	0x3C407C42427C0000,//g
	0x00424242423E0202,//h
	0x003C1010101C0018,//i
	0x0E101010101C0018,//j
	0x0042221E22420200,//k
	0x003C101010101018,//l
	0x00829292AA440000,//m
	0x00424242423E0000,//n
	0x003C4242423C0000,//o
	0x02023E42423E0000,//p
	0xC0407C42427C0000,//q
	0x00020202463A0000,//r
	0x003E403C027C0000,//s
	0x00380404043E0404,//t
	0x003C424242420000,//u
	0x0018244242420000,//v
	0x006C929292820000,//w
	0x0042241824420000,//x
	0x3C407C4242420000,//y
	0x007E0418207E0000,//z
	0x003018180E181830,//{
	0x0018181818181818,//|
	0x000C18187018180C,//}
	0x000000000062D68C,//~
	0xFFFFFFFFFFFFFFFF,
	0x1E30181E3303331E,//€
	0x007E333333003300,//
	0x001E033F331E0038,//‚
	0x00FC667C603CC37E,//ƒ
	0x007E333E301E0033,//„
	0x007E333E301E0007,//…
	0x007E333E301E0C0C,//†
	0x3C603E03033E0000,//‡
	0x003C067E663CC37E,//ˆ
	0x001E033F331E0033,//‰
	0x001E033F331E0007,//Š
	0x001E0C0C0C0E0033,//‹
	0x003C1818181C633E,//Œ
	0x001E0C0C0C0E0007,//
	0x00333F33331E0C33,//Ž
	0x00333F331E000C0C,//
	0x003F061E063F0038,//
	0x00FE33FE30FE0000,//‘
	0x007333337F33367C,//’
	0x001E33331E00331E,//“
	0x001E33331E003300,//”
	0x001E33331E000700,//•
	0x007E33333300331E,//–
	0x007E333333000700,//—
	0x1F303F3333003300,//˜
	0x001C3E63633E1C63,//™
	0x001E333333330033,//š
	0x18187E03037E1818,//›
	0x003F67060F26361C,//œ
	0x000C3F0C3F1E3333,//
	0x70337B332F1B1B0F,//ž
	0x0E1B18187E18D870,//Ÿ
	0x007E333E301E0038,//
	0x001E0C0C0C0E001C,//¡
	0x001E33331E003800,//¢
	0x007E333333003800,//£
	0x003333331F001F00,//¤
	0x00333B3F3733003F,//¥
	0x00007E007C36363C,//¦
	0x00007E003C66663C,//§
	0x001E3303060C000C,//¨
	0x000003033F000000,//©
	0x000030303F000000,//ª
	0xF81973C67C1B3363,//«
	0xC0F9F3E6CF1B3363,//¬
	0x183C3C1818001800,//­
	0x0000CC663366CC00,//®
	0x00003366CC663300,//¯
	0x1144114411441144,//°
	0x55AA55AA55AA55AA,//±
	0xEEBBEEBBEEBBEEBB,//²
	0x1818181818181818,//³
	0x1818181F18181818,//´
	0x1818181F181F1818,//µ
	0x6C6C6C6F6C6C6C6C,//¶
	0x6C6C6C7F00000000,//·
	0x1818181F181F0000,//¸
	0x6C6C6C6F606F6C6C,//¹
	0x6C6C6C6C6C6C6C6C,//º
	0x6C6C6C6F607F0000,//»
	0x0000007F606F6C6C,//¼
	0x0000007F6C6C6C6C,//½
	0x0000001F181F1818,//¾
	0x1818181F00000000,//¿
	0x000000F818181818,//À
	0x000000FF18181818,//Á
	0x181818FF00000000,//Â
	0x181818F818181818,//Ã
	0x000000FF00000000,//Ä
	0x181818FF18181818,//Å
	0x181818F818F81818,//Æ
	0x6C6C6CEC6C6C6C6C,//Ç
	0x000000FC0CEC6C6C,//È
	0x6C6C6CEC0CFC0000,//É
	0x000000FF00EF6C6C,//Ê
	0x6C6C6CEF00FF0000,//Ë
	0x6C6C6CEC0CEC6C6C,//Ì
	0x000000FF00FF0000,//Í
	0x6C6C6CEF00EF6C6C,//Î
	0x000000FF00FF1818,//Ï
	0x000000FF6C6C6C6C,//Ð
	0x181818FF00FF0000,//Ñ
	0x6C6C6CFF00000000,//Ò
	0x000000FC6C6C6C6C,//Ó
	0x000000F818F81818,//Ô
	0x181818F818F80000,//Õ
	0x6C6C6CFC00000000,//Ö
	0x6C6C6CEF6C6C6C6C,//×
	0x181818FF00FF1818,//Ø
	0x0000001F18181818,//Ù
	0x181818F800000000,//Ú
	0xFFFFFFFFFFFFFFFF,//Û
	0xFFFFFFFF00000000,//Ü
	0x0F0F0F0F0F0F0F0F,//Ý
	0xF0F0F0F0F0F0F0F0,//Þ
	0x00000000FFFFFFFF,//ß
	0x006E3B133B6E0000,//à
	0x03031F331F331E00,//á
	0x0003030303637F00,//â
	0x0036363636367F00,//ã
	0x007F660C180C667F,//ä
	0x001E3333337E0000,//å
	0x03063E6666666600,//æ
	0x00181818183B6E00,//ç
	0x3F0C1E33331E0C3F,//è
	0x001C36637F63361C,//é
	0x007736366363361C,//ê
	0x001E33333E180C38,//ë
	0x00007EDBDB7E0000,//ì
	0x03067EDBDB7E3060,//í
	0x003C06033F03063C,//î
	0x003333333333331E,//ï
	0x00003F003F003F00,//ð
	0x003F000C0C3F0C0C,//ñ
	0x003F00060C180C06,//ò
	0x003F00180C060C18,//ó
	0x1818181818D8D870,//ô
	0x0E1B1B1818181818,//õ
	0x000C0C003F000C0C,//ö
	0x0000394E00394E00,//÷
	0x000000001C36361C,//ø
	0x0000001818000000,//ù
	0x0000001800000000,//ú
	0x383C3637303030F0,//û
	0x000000363636361E,//ü
	0x0000003E061C301E,//ý
	0x00003C3C3C3C0000,//þ
	0xFFFFFFFFFFFFFFFF //ÿ
};